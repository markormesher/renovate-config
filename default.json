// vi: ft=jsonc

{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:best-practices"],

  // commit appearance
  "gitAuthor": "Renovate Bot <renovate@markormesher.co.uk>",
  "semanticCommits": "enabled",
  "semanticCommitType": "chore",
  "semanticCommitScope": "",

  // pr appearance
  "labels": ["ðŸ¤– renovate"],
  "prBodyColumns": [
    "Package",
    "Type",
    "Update",
    "Change",
    "Age",
    "Adoption",
    "Passing",
    "Confidence"
  ],

  // renovate behaviour
  "recreateWhen": "always",
  "pruneStaleBranches": true,
  "osvVulnerabilityAlerts": true,
  "pinDigests": true,

  // no limits
  "prHourlyLimit": 0,
  "prConcurrentLimit": 0,
  "branchConcurrentLimit": 0,

  // tidy lockfiles after making changes
  "postUpdateOptions": ["yarnDedupeHighest", "gomodTidy"],

  // create PRs on Friday/Saturday only
  "schedule": "* * * * 5,6",

  "kubernetes": {
    "fileMatch": [
      ".*\.ya?ml$"
    ]
  },

  "packageRules": [

    // verison pinning

    {
      "description": "Auto-merge any pin updates",
      "matchUpdateTypes": ["pin", "pinDigest"],
      "addLabels": ["automerge"]
    },

    // build tooling

    {
      "description": "Auto-merge any patch or minor updates to build tooling",
      "matchPackagePrefixes": [
        "@markormesher/eslint-config",
        "cimg/base",
        "docker.io/alpine/git",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "eslint",
        "ghcr.io/markormesher/task-fetcher",
        "quay.io/podman/stable"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "semanticCommitType": "build",
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to package managers",
      "matchDepTypes": ["packageManager"],
      "matchUpdateTypes": ["patch", "minor"],
      "semanticCommitType": "build",
      "addLabels": ["automerge"]
    },

    // base layers

    {
      "description": "Auto-merge any patch or minor updates to common base images",
      "matchPackageNames": [
        "docker.io/debian",
        "ghcr.io/markormesher/scratch"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },

    // langauges

    {
      "description": "Group and auto-merge any patch or minor updates to Node",
      "groupName": "Node language and base images",
      "matchPackageNames": [
        "node",
        "docker.io/node",
        "cimg/node"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Group and auto-merge any patch or minor updates to Go",
      "groupName": "Go language and base images",
      "matchPackageNames": [
        "go",
        "golang",
        "docker.io/golang",
        "cimg/go"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },

    // actual package dependencies

    {
      "description": "Auto-merge any patch or minor updates to dev dependencies",
      "matchDepTypes": ["devDependencies"],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to Golang.org packages",
      "matchPackagePrefixes": [
        "golang.org/x"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch updates to well-versioned packages",
      "matchPackagePrefixes": [
        "@bufbuild/",
        "@connectrpc/",
        "connectrpc.com/",
        "google.golang.org/protobuf"
      ],
      "matchUpdateTypes": ["patch"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Group protobuf packages",
      "groupName": "connectrpc",
      "matchPackagePrefixes": [
        "@bufbuild/",
        "@connectrpc/",
        "connectrpc.com/",
        "google.golang.org/protobuf"
      ]
    },

    // misc

    {
      "description": "Auto-merge any digest updates",
      "matchUpdateTypes": ["digest"],
      "addLabels": ["automerge"]
    }
  ]
}
