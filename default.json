// vi: ft=jsonc

{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:best-practices"],

  // commit appearance
  "semanticCommits": "enabled",
  "semanticCommitType": "chore",
  "semanticCommitScope": "",

  // pr appearance
  "labels": ["ðŸ¤– renovate"],
  "prBodyColumns": [
    "Package",
    "Type",
    "Update",
    "Change",
    "Age",
    "Adoption",
    "Passing",
    "Confidence"
  ],

  // renovate behaviour
  "recreateWhen": "always",
  "pruneStaleBranches": true,
  "osvVulnerabilityAlerts": true,
  "pinDigests": true,

  // no limits
  "prHourlyLimit": 0,
  "prConcurrentLimit": 0,
  "branchConcurrentLimit": 0,

  // tidy lockfiles after making changes
  "postUpdateOptions": ["yarnDedupeHighest", "gomodTidy"],

  "kubernetes": {
    "fileMatch": [
      ".*\.ya?ml$"
    ]
  },

  "packageRules": [

    // verison pinning

    {
      "description": "Auto-merge any pin or digest updates",
      "matchUpdateTypes": ["pin", "pinDigest", "digest"],
      "addLabels": ["automerge"]
    },

    // build tooling
    // note: don't include language images here
    // note: these rules work in pairs; one to set the commit type for ALL upgrades, one to auto merge SOME upgrades

    {
      "description": "Set commit type for CI packages",
      "matchFileNames": [
        ".circleci/config.yml",
        ".drone.yml"
      ],
      "matchPackagePrefixes": [
        "cimg/base",
        "docker.io/alpine/git",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "ghcr.io/markormesher/task-fetcher",
        "quay.io/podman/stable"
      ],
      "semanticCommitType": "ci"
    },
    {
      "description": "Auto-merge any patch or minor updates to CI packages",
      "matchFileNames": [
        ".circleci/config.yml",
        ".drone.yml"
      ],
      "matchPackagePrefixes": [
        "cimg/base",
        "docker.io/alpine/git",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "ghcr.io/markormesher/task-fetcher",
        "quay.io/podman/stable"
      ],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },

    {
      "description": "Set commit type for build packages",
      "matchPackagePrefixes": [
        "@markormesher/eslint-config",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "eslint"
      ],
      "semanticCommitType": "build"
    },
    {
      "description": "Auto-merge any patch or minor updates to build tooling",
      "matchPackagePrefixes": [
        "@markormesher/eslint-config",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "eslint"
      ],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },

    {
      "description": "Set commit type for package managers",
      "matchDepTypes": ["packageManager"],
      "semanticCommitType": "build"
    },
    {
      "description": "Auto-merge any patch or minor updates to package managers",
      "matchDepTypes": ["packageManager"],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },

    // base layers

    {
      "description": "Auto-merge any patch or minor updates to common base images",
      "matchPackageNames": [
        "docker.io/debian",
        "ghcr.io/markormesher/scratch"
      ],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },

    // langauges

    {
      "description": "Group and auto-merge any patch or minor updates to Node",
      "groupName": "Node language and base images",
      "matchPackageNames": [
        "node",
        "docker.io/node",
        "cimg/node"
      ],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Group and auto-merge any patch or minor updates to Go",
      "groupName": "Go language and base images",
      "matchPackageNames": [
        "go",
        "golang",
        "docker.io/golang",
        "cimg/go"
      ],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },

    // actual package dependencies

    {
      "description": "Auto-merge any patch or minor updates to dev dependencies",
      "matchDepTypes": ["devDependencies"],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to Golang.org packages",
      "matchPackagePrefixes": [
        "golang.org/x"
      ],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch updates to well-versioned packages",
      "matchPackagePrefixes": [
        "@bufbuild/",
        "@connectrpc/",
        "connectrpc.com/",
        "google.golang.org/protobuf",
        "material-symbols"
      ],
      "matchUpdateTypes": ["digest", "patch"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Group protobuf packages",
      "matchPackagePrefixes": [
        "@bufbuild/",
        "@connectrpc/",
        "connectrpc.com/",
        "google.golang.org/protobuf"
      ],
      "groupName": "connectrpc"
    }
  ]
}
