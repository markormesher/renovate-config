// vi: ft=jsonc

{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:best-practices"],

  // commit appearance
  "semanticCommits": "enabled",
  "semanticCommitType": "chore",
  "semanticCommitScope": "",

  // pr appearance
  "labels": ["ðŸ¤– renovate"],
  "prBodyColumns": [
    "Package",
    "Type",
    "Update",
    "Change",
    "Age",
    "Adoption",
    "Passing",
    "Confidence"
  ],

  // renovate behaviour
  "recreateWhen": "always",
  "pruneStaleBranches": true,
  "osvVulnerabilityAlerts": true,
  "pinDigests": true,

  // no limits
  "prHourlyLimit": 0,
  "prConcurrentLimit": 0,
  "branchConcurrentLimit": 0,

  // tidy lockfiles after making changes
  "postUpdateOptions": ["yarnDedupeHighest", "gomodTidy"],

  "kubernetes": {
    "fileMatch": [
      ".*\.ya?ml$"
    ]
  },

  "packageRules": [

    // set semantic commit types
    // note: "build" is used for packages used in the build or CI process, which are not expected to change outputs; "ci" is unused.
    {
      "description": "Set semantic commit type for build packages",
      "matchFileNames": [
        ".circleci/config.yml",
        ".drone.yml"
      ],
      "matchPackagePrefixes": [
        "@markormesher/eslint-config",
        "cimg/",
        "docker.io/alpine/git",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "eslint",
        "ghcr.io/markormesher/task-fetcher",
        "quay.io/podman/stable",
        "vite"
      ],
      "semanticCommitType": "build"
    },
    {
      "description": "Set semantic commit type for dev dependencies",
      "matchDepTypes": ["devDependencies"],
      "semanticCommitType": "build"
    },
    {
      "description": "Set semantic commit type for package managers",
      "matchDepTypes": ["packageManager"],
      "semanticCommitType": "build"
    },

    // package grouping
    {
      "description": "Group Go packages",
      "matchPackageNames": [
        "go",
        "golang",
        "docker.io/golang",
        "cimg/go"
      ],
      "groupName": "go"
    },
    {
      "description": "Group Node packages",
      "matchPackageNames": [
        "node",
        "docker.io/node",
        "cimg/node"
      ],
      "groupName": "node"
    },
    {
      "description": "Group protobuf packages",
      "matchPackagePrefixes": [
        "@bufbuild/",
        "@connectrpc/",
        "connectrpc.com/",
        "google.golang.org/protobuf"
      ],
      "groupName": "connectrpc"
    },

    // auto-merge rules
    {
      "description": "Auto-merge any version pinning",
      "matchUpdateTypes": ["pin", "pinDigest"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to package managers",
      "matchDepTypes": ["packageManager"],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to dev dependencies",
      "matchDepTypes": ["devDependencies"],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to well-versioned packages",
      "matchPackagePrefixes": [
        // build tools
        "@markormesher/eslint-config",
        "cimg/",
        "docker.io/alpine/git",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "eslint",
        "ghcr.io/markormesher/task-fetcher",
        "quay.io/podman/stable",
        "vite",

        // languages
        "go",
        "node",

        // base layers
        "ghcr.io/markormesher/scratch",
        "docker.io/debian",
        "docker.io/golang",
        "docker.io/node",

        // dependencies
        "@bufbuild/",
        "@connectrpc/",
        "connectrpc.com/",
        "golang.org/x",
        "google.golang.org/protobuf",
        "material-symbols"
      ],
      "matchUpdateTypes": ["digest", "patch", "minor"],
      "addLabels": ["automerge"]
    }
  ]
}
