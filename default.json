// vi: ft=jsonc

{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":semanticCommitTypeAll(chore)"
  ],

  // commit appearance
  "gitAuthor": "Renovate Bot <renovate@markormesher.co.uk>",
  "semanticCommits": "enabled",
  "labels": ["ðŸ¤– renovate"],

  // renovate behaviour
  "recreateWhen": "always",
  "pruneStaleBranches": true,
  "osvVulnerabilityAlerts": true,
  "dependencyDashboard": false,
  "minimumReleaseAge": "2 days",
  "prConcurrentLimit": 0,
  "branchConcurrentLimit": 0,

  // tidy lockfiles after making changes
  "postUpdateOptions": ["yarnDedupeHighest", "gomodTidy"],

  // create PRs on Friday/Saturday only
  "schedule": "* * * * 5,6",

  "kubernetes": {
    "fileMatch": [
      ".*\.ya?ml$"
    ]
  },

  "docker": {
    "pinDigests": true
  },

  "packageRules": [

    // build tooling

    {
      "description": "Auto-merge any patch or minor updates to build tooling",
      "matchPackagePrefixes": [
        "cimg/base",
        "docker.io/alpine/git",
        "docker.io/bufbuild/buf",
        "docker.io/busybox",
        "ghcr.io/markormesher/task-fetcher",
        "quay.io/podman/stable"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "semanticCommitType": "build",
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to package managers",
      "matchDepTypes": ["packageManager"],
      "matchUpdateTypes": ["patch", "minor"],
      "semanticCommitType": "build",
      "addLabels": ["automerge"]
    },

    // base layers

    {
      "description": "Auto-merge any patch or minor updates to common base images",
      "matchPackageNames": [
        "docker.io/debian",
        "ghcr.io/markormesher/scratch"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },

    // langauges

    {
      "description": "Auto-merge any patch or minor updates to Node",
      "groupName": "Node language and base images",
      "matchPackageNames": [
        "node",
        "docker.io/node",
        "cimg/node"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to Go",
      "groupName": "Go language and base images",
      "matchPackageNames": [
        "go",
        "golang",
        "docker.io/golang",
        "cimg/go"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },

    // actual package dependencies

    {
      "description": "Auto-merge any patch or minor updates to dev dependencies",
      "matchDepTypes": ["devDependencies"],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch or minor updates to Golang.org packages",
      "matchPackagePrefixes": [
        "golang.org/x"
      ],
      "matchUpdateTypes": ["patch", "minor"],
      "addLabels": ["automerge"]
    },
    {
      "description": "Auto-merge any patch updates to well-versioned packages",
      "matchPackagePrefixes": [
        "google.golang.org/protobuf",
        "connectrpc.com/connect"
      ],
      "matchUpdateTypes": ["patch"],
      "addLabels": ["automerge"]
    },

    // misc

    {
      "description": "Auto-merge any digest updates",
      "matchUpdateTypes": ["digest"],
      "addLabels": ["automerge"]
    }
  ]
}
